<!DOCTYPE html>
<html>
<head>
    <script src="/js/sockjs.js"></script>
    <script src="/js/stomp.js"></script>
    <script src="/js/jquery.min.js"></script>

    <script type="text/javascript">
        var stompClient = null;

        //连接
        function connect() {
            var socket = new SockJS('/my-websocket'); //连接SockJS的endpoint名称为"endpointWisely
            stompClient = Stomp.over(socket);    //使用STMOP子协议的WebSocket客户端

            stompClient.connect({}, function (frame) { //连接WebSocket服务端
                setConnected(true);
                console.log('Connected:' + frame);
                //通过stompClient.subscribe订阅/topic/getResponse 目标(destination)发送的消息,这个是在控制器的@SentTo中定义的
                stompClient.subscribe('/topic/send', function (response) {
                    showResponse(JSON.parse(response.body).responseMessage);
                });

                /*// 注册发送消息
                 stompClient.subscribe('/topic/send', function(msg) {
                 data.rows.push(JSON.parse(msg.body));
                 data.connected = true;
                 });
                 // 注册推送时间回调
                 stompClient.subscribe('/topic/callback', function(r) {
                 data.time = '当前服务器时间：' + r.body;
                 data.connected = true;

                 });*/
            });
        };

        function setConnected(connected) {
            $('#connect').attr("disabled", connected);
            $('#disconnect').attr("disabled", !connected);
            document.getElementById('conversationDiv').style.visibility = connected ? 'visible' : 'hidden';
            $("#response").html();
        }

        function disconnect() {
            if (stompClient != null) {
                stompClient.disconnect();
            }
            setConnected(false);
            console.log("Disconnected");
        }

        function sendName() {
            var name = $("#name").val();
            //通过stompClient.send向/welcome 目标(destination)发送消息,这个是在控制器的@MessageMapping中定义的
            stompClient.send("/topic/send", {}, JSON.stringify({'message': name}));
            //TODO
        }

        function showResponse(message) {
            $("#response").html(message);
        }

    </script>
</head>
<body>

<noscript><h2 style="color:#ff0000">抱歉,您的浏览器不支持改功能!</h2></noscript>
<div>
    <div>
        <button id="connect" onclick="connect();">连接</button>
        <button id="disconnect" disabled="disabled" onclick="disconnect();">断开连接</button>
    </div>
    <div id="conversationDiv">
        <label>请输入您的姓名</label><input type="text" id="name"/>
        <button id="sendName" onclick="sendName();">发送</button>
        <p id="response"></p>
    </div>
</div>

<!--<label>WebSocket连接状态:</label>
<button type="button" onclick="connect()">连接</button>
<button type="button" onclick="disconnect()">断开</button>
<br />
<br />
<div>
    <label>{{data.time}}</label> <br /> <br />
    <input id="msg" type="text" placeholder="请输入内容..." />
    <button onclick="send()" type="button">发送</button>
    <br /> <br /> 消息列表： <br />
    <table>
        <thead>
        <tr>
            <th>内容</th>
            <th>时间</th>
        </tr>
        </thead>
        <tbody>
        <tr ng-repeat="row in data.rows">
            <td>{{row.message}}</td>
            <td>{{row.date}}</td>
        </tr>
        </tbody>
    </table>
</div>-->
</body>
</html>